---
title: "Project"
author: "Olga Potanina"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(openxlsx)
library (tidyverse)
library(vegan)
library(broom) 
library (flextable)
```

## –ß—Ç–µ–Ω–∏–µ, —Å–ª–∏—è–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤

-   –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–¥–æ—Ä–æ–≤—ã—Ö –ª—é–¥—è—Ö (`info_healthy`) –∏ –ø–∞—Ü–∏–µ–Ω—Ç–∞—Ö —Å –°–†–ö (`info_ibs`)

```{r, message=FALSE}

info_healthy <- read_xlsx ("data/raw/final_health_statistic.xlsx")
info_ibs <- read_xlsx ("data/raw/final_ibs_141_statistic.xlsx")

```

-   –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ `info_healthy` –∏ `info_ibs`

```{r, echo=FALSE}

cat (
c ("–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ info_ibs:", info_ibs %>% 
  select (- c (intersect (names(info_healthy), names(info_ibs)))) %>% colnames()),
c ("–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ info_healthy:", info_healthy %>% 
  select (- c (intersect (names(info_ibs), names(info_healthy)))) %>% colnames()), 
sep = "\n") 

```

#### combined_info

-   –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ `info_healthy` –∏ `info_ibs` –≤ –µ–¥–∏–Ω—ã–π –¥–∞—Ç–∞—Å–µ—Ç `combined_info` c —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ

```{r combined_info, message=FALSE}

combined_info <- info_healthy %>% 
  bind_rows(info_ibs) %>%
  mutate (
    BMI_min = ifelse (is.na (BMI_min), round (Weight_min /(Height_max/100 * Height_max/100), 2), BMI_min),
    BMI_max = ifelse (is.na (BMI_max), round (Weight_max /(Height_min/100 * Height_min/100), 2), BMI_max)
    ) %>% 
  unite("BMI_range", BMI_min, BMI_max, sep = "-", na.rm = TRUE) %>%
  unite ("Age_range", Age_min, Age_max, sep = "-", na.rm = TRUE) %>%
  mutate(
    Age_range = case_when(
      Age_range == "18-40" | Age_range == "23-28" | Age_range == "16-42" | Age_range == "21-43" ~ "16-43",
      Age <= 43 ~ "16-43",
      Age > 43 ~ "> 43",
      TRUE ~ NA_character_), #—É–¥–∞–ª–µ–Ω–∞ –≥—Ä—É–ø–ø–∞ 28-54
    research_ID = sub ("research_", "", research_ID),
    research_ID = case_when(
      research_ID == 0 ~ 1,
      research_ID == 1 ~ 2,
      research_ID == 2 ~ 3,
      research_ID == 3 ~ 4,
      research_ID == 4 ~ 5, 
      research_ID == 6 ~ 6, 
      research_ID == 7 ~ 7), 
    patient_ID = row_number(),
    Sex = ifelse (Sex == "mixed", NA, Sex),
    Smoking = sub ("never", "Never",  Smoking),
    Smoking = case_when(
      Smoking == "No" ~ "No",
      Smoking == "Never" ~ "No",
      Smoking == "Rarely (a few times/month)" ~ "Yes", #5 —á–µ–ª.
      Smoking == "Occasionally (1-2 times/week)" ~ "Yes",  #3 —á–µ–ª.
      Smoking == "Regularly (3-5 times/week)" ~ "Yes",  #1 —á–µ–ª.
      Smoking == "Daily" ~ "Yes"), #7 —á–µ–ª.
    Alcohol = sub ("rarely", "Rarely", Alcohol),
    Alcohol = ifelse(Alcohol == "Regularly (3-5 times/week)"|
                       Alcohol == "Daily", #3 —á–µ–ª.
                     "Regularly (3-7 times/week)", Alcohol),
    Antibiotics_usage = case_when(
      Antibiotics_usage == "Month" | Antibiotics_usage == ~ "3 months" |
        Antibiotics_usage == "6 months" ~ "1-6 months",
        #2 —á–µ–ª. –±–æ–ª—å–Ω—ã—Ö Month, 0 —á–µ–ª. –∑–¥–æ—Ä–æ–≤—ã—Ö 3 months, 0 —á–µ–ª. –∑–¥–æ—Ä–æ–≤—ã—Ö –¥–ª—è 6 months
      Antibiotics_usage == "Year" | Antibiotics_usage == "Not use"  ~ 
        "12 months/Not use"), # 0 —á–µ–ª. –∏–∑ –∑–¥–æ—Ä–æ–≤—ã—Ö –¥–ª—è 6-12 months, 0 —á–µ–ª. –±–æ–ª—å–Ω—ã—Ö –¥–ª—è Not use
    Hygiene = case_when(
      Hygiene == "Occasionally (1-2 times/week) cosmetics" ~ "Occasionally cosmetics (1-2 times/week)",
      Hygiene == "Rarely (a few times/month) cosmetics" ~ "Rarely cosmetics (a few times/month)",
      TRUE ~ Hygiene),
    Hygiene = case_when(
      Hygiene == "Daily cosmetics"|Hygiene == "Regularly cosmetics (3-5 times/week)" ~ "Regularly (3-7 times/week)", #0 —á–µ–ª. –±–æ–ª—å–Ω—ã—Ö  –¥–ª—è 3-5 times/week
      Hygiene == "Occasionally cosmetics (1-2 times/week)" | Hygiene == "Rarely cosmetics (a few times/month)" ~ "Occasionally (a few-8 times/month)",
      #—Ç–æ–ª—å–∫–æ 2 —á–µ–ª. –±–æ–ª—å–Ω—ã—Ö –¥–ª—è 1-2 times/week
      Hygiene == "Never cosmetics" ~ "Never"),
    Physical_activity = sub ("regularly", "Regularly",  Smoking),
    BMI = ifelse (is.na(Weight_kg), BMI, Weight_kg/ (Height_cm/100 * Height_cm/100)),
    BMI_range = ifelse(BMI_range == "", NA, BMI_range),
    BMI_category = case_when(
      BMI_range == "18-25" ~ "normal/overweight",
      BMI_range == "19.21-29.29" ~ "normal/overweight",
      BMI_range == "20.6-29.6" ~ "normal/overweight",
      BMI_range == "21.74-28.38" ~ "normal/overweight",
      BMI_range == "18.5-30.8" ~ "normal/overweight", #–Ω–µ–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ 30
      BMI < 18.5 ~ "underweight",
      BMI >= 18.5 & BMI < 30 ~ "normal/overweight",
      BMI >= 30 ~ "obese")
    ) %>% 
  rename ("Cosmetics" = Hygiene ) %>% 
  
  mutate_if (is.character, as.factor) %>% 
  
  select(-c(
    Instrument, # unique (combined_info$Instrument) = "Illumina MiSeq" 
    Isolation_source, # unique (combined_info$Isolation_source) = "faeces" 
    Assay_type, # unique (combined_info$Assay_type) = "AMPLICON"
    Target_gene, # unique (combined_info$Target_gene) = "16S"
    Main_Disease, # unique (combined_info$Main_Disease) = NA (for healthy), 141 (for ibs)
    Drugs, # unique (combined_info$Drugs) = NA
    Social_status, # unique (combined_info$Social_status) =  NA, urban 
    Weight_kg, Height_cm, Weight_min, Weight_max, Height_min, Height_max, BMI_range, #–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è BMI_category, —É–º–µ–Ω—å—à–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ NA –≤ BMI
    BMI, # NA —É –≤—Å–µ—Ö –∑–¥–æ—Ä–æ–≤—ã—Ö
    Birth_Year, # –∏–º–µ—é—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—Ö —Å–ª—É—á–∞—è—Ö, –≥–¥–µ –≤–æ–∑—Ä–∞—Å—Ç —É–∂–µ –∏–∑–≤–µ—Å—Ç–µ–Ω
    Pets_type # —Ç–æ–ª—å–∫–æ cat –∏ NA
  ))

rm (info_healthy, info_ibs)
summary (combined_info)

```

-   –¢–∞–±–ª–∏—Ü–∞ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å—É–±—ä–µ–∫—Ç–æ–≤ (n) –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –¥–∞—Ç—ã, –Ω–∞–ª–∏—á–∏—è/–æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –°–†–ö

```{r, message=FALSE}

combined_info %>% 
  select (research_ID, Country, Seq_date, Health_state) %>% 
  group_by(research_ID, Country, Seq_date, Health_state) %>% 
  summarise(n = n()) %>% 
  flextable() %>% theme_box() %>% 
  merge_v(c ("research_ID", "Country", "Seq_date", "Health_state")) %>% 
  align(align = "center", part = "all")

```

#### tbl_summary of combined_info

```{r, message=FALSE}

library(gtsummary)

combined_info %>% 
  select(! c(patient_ID,
              Diet_duration, Additive_usage, Diet_type #—É –≤—Å–µ—Ö –∑–¥–æ—Ä–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ = NA
              )) %>% 
  tbl_summary(digits = list(all_continuous() ~ c(0, 0),
                            all_categorical() ~ c(0, 0)),
              by = Health_state) %>%
  add_p()

```

-   –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –º–∏–∫—Ä–æ–±–∏–æ–º–µ –∑–¥–æ—Ä–æ–≤—ã—Ö –ª—é–¥–µ–π (`bacteria_healthy`) –∏ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ —Å –°–†–ö (`bacteria_ibs`) –∏ –∏—Ö –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤ `combined_bacteria`

```{r combined_bacteria, message = FALSE}

bacteria_healthy <- read_csv("data/raw/final_bacteria_health.csv")
bacteria_ibs <- read_csv("data/raw/final_bacteria_ibs_141.csv")

combined_bacteria <- bacteria_healthy %>% 
  bind_rows (bacteria_ibs) %>% 
  mutate(patient_ID = row_number())

rm (bacteria_healthy, bacteria_ibs)

```

-   –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ `combined_bacteria` –∏ `combined_info` –≤ `data_wide`

```{r data_wide, message=FALSE}

data_wide <- combined_info %>% 
  left_join (combined_bacteria)

```

## –û—Ü–µ–Ω–∫–∞ –¥–æ–ª–∏ NA –∏ –Ω—É–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

-   –û—Ü–µ–Ω–∫–∞ –¥–æ–ª–∏ NA –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö `data_wide`

```{r}

data_wide %>% 
  select (where (function(x) sum (is.na(x))/ nrow(data_wide) * 100 > 0)) %>% 
  sapply (function(x) sum (is.na(x))/ nrow(data_wide) * 100) %>% round(1) %>% 
  as.data.frame() %>% 
  rename(NA_percentage = ".") %>% 
  mutate (
    "Number of people with known data" = round (nrow(data_wide) - NA_percentage/100 * nrow(data_wide)),
    NA_percentage = paste (NA_percentage, "%", sep = " ")
    ) %>% 
  arrange(desc (NA_percentage)) %>% 
  rownames_to_column() %>% 
  as_tibble() %>% flextable()

```

-   –†–∞—Å—Å—á–∏—Ç–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–µ NA –∏ –Ω–µ 0 –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º —à–∏—Ä–æ–∫–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞

```{r calculate percentage for each variable}

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ä–æ–≥ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ 
threshold_percent <- 95 
 
# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –∑–∞–ø–∏—Å–µ–π, –Ω–µ —Ä–∞–≤–Ω—ã—Ö NA –∏ –Ω–µ —Ä–∞–≤–Ω—ã—Ö 0, –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–∏ 
calculate_percentage <- function(col) { 
  sum(!is.na(col) & col != 0) / length(col) * 100 
} 
 
# –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∫ –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–µ –≤ –¥–∞—Ç–∞—Å–µ—Ç–µ 
percentage_non_zero_non_na <- sapply(data_wide[, -1], calculate_percentage) 
 
# –°–æ–∑–¥–∞–µ–º –¥–∞—Ç–∞—Ñ—Ä–µ–π–º —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ 
result_df_sort <- data.frame( 
  column = names(percentage_non_zero_non_na), 
  percentage = round(100 - percentage_non_zero_non_na, 2) # percentage –æ–∑–Ω–∞—á–∞–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∏–ª–∏ 0 –∑–Ω–∞—á–µ–Ω–∏—è
) %>% 
  arrange(desc(percentage))
 
# –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø–∏—Å–µ–π –º–µ–Ω–µ–µ threshold_percent% 
filtered_columns <- result_df_sort[result_df_sort$percentage < threshold_percent, ]

# –°–æ—Ö—Ä–∞–Ω–∏–º –¥–∞—Ç–∞—Å–µ—Ç –≤ excel –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
write.xlsx(filtered_columns, 
           file = "data/originals/percentage_by_vars.xlsx")

# –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å data_wide —Å –≤—ã–±–æ—Ä–æ–º –∫–æ–ª–æ–Ω–æ–∫ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º NA/0 –º–µ–Ω–µ–µ threshold_percent 
data_wide <- data_wide %>% 
  select (row.names(filtered_columns), research_ID)

rm (calculate_percentage, result_df_sort)

```

-   –†–∞—Å—Å—á–∏—Ç–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–µ NA –∏ –Ω–µ 0 –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É `patient_ID`

```{r}
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ä–æ–≥ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ 
threshold_percent <- 95
 
# –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –∑–Ω–∞—á–µ–Ω–∏–π, –Ω–µ —è–≤–ª—è—é—â–∏—Ö—Å—è NA –∏ –Ω–µ —Ä–∞–≤–Ω—ã—Ö 0, –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞ 
percentage_non_zero_non_na <- rowMeans(!is.na(data_wide) & data_wide != 0, na.rm = TRUE) * 100 
 
# –°–æ–∑–¥–∞–µ–º –¥–∞—Ç–∞—Ñ—Ä–µ–π–º —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ 
result_df_sort <- data.frame( 
  patient_id = data_wide$patient_ID, 
  percentage = round(100 - percentage_non_zero_non_na, 2) # percentage –æ–∑–Ω–∞—á–∞–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∏–ª–∏ 0 –∑–Ω–∞—á–µ–Ω–∏—è
) %>% arrange(desc(percentage))

# –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–æ—Ü–µ–Ω—Ç –∑–Ω–∞—á–µ–Ω–∏–π –º–µ–Ω–µ–µ threshold_percent% 
filtered_patients <- result_df_sort[result_df_sort$percentage < threshold_percent, ] 

# –°–æ—Ö—Ä–∞–Ω–∏–º –¥–∞—Ç–∞—Å–µ—Ç –≤ excel –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ 
write.xlsx(filtered_patients,
           file = "data/originals/percentage_by_patient.xlsx") 

# –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å data_wide —Å —É–¥–∞–ª–µ–Ω–∏–µ–º —Å—Ç—Ä–æ–∫ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º NA/0 –±–æ–ª–µ–µ threshold_percent 
data_wide <- data_wide %>% 
  slice (filtered_patients$patient_id) #–ø—Ä–∏ threshold_percent = 95%, –∏–∑–º–µ–Ω–µ–Ω–∏—è data_wide –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, —Ç–∞–∫ –∫–∞–∫ –Ω–µ—Ç –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º NA/0 –±–æ–ª–µ–µ 95%

rm (percentage_non_zero_non_na, result_df_sort)

```

-   –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `data_wide` –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ –∏ —Å—Ç—Ä–æ–∫ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º NA/0 –±–æ–ª–µ–µ threshold_percent

```{r}
data_wide <- data_wide %>% 
  select (patient_ID, any_of (colnames(combined_info)), everything()) %>% 
  arrange(patient_ID)

write_rds(data_wide, 
          file = "data/originals/data_wide.rds")

```

### bac_functions

-   –∑–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ `bac_functions`

```{r}

# –ß—Ç–µ–Ω–∏–µ –ª–∏—Å—Ç–æ–≤ Excel-—Ñ–∞–π–ª–∞ —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –±–∞–∫—Ç–µ—Ä–∏–π –∏ –∏—Ö –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ
path <- "data/raw/Bacterial group functions.xlsx"
taxon <- c ("TaxonName", "Rank")

neuromediators <- read_xlsx (path, 2) %>% 
  mutate(Destroy = ifelse(is.na (Destroy), "produce", "destroy")) %>% 
  unique() %>%
  pivot_wider(names_from = Neuromediator, values_from = Destroy)

probiotics <- read_xlsx (path, 3) %>% 
  add_column(probiotics = 1)

special_properties <- read_xlsx (path, 4) %>% 
  add_column(special_properties = 1)

vitamins <- read_xlsx (path, 5) %>% 
  pivot_wider (names_from = Vitamin, values_from = Vitamin,
               values_fn = function(x) ifelse(is.na (x), NA, 1))

habbits <- read_xlsx (path, 7) %>%
  unique() %>% #—É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å—Ç—Ä–æ–∫ 
  pivot_wider(names_from = Habbit, values_from = Habit_state)

bac_functions <- read_xlsx (path, 1) %>% #–ü–∞—Ç–æ–≥–µ–Ω—ã –∏ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ
  full_join(neuromediators, by = taxon) %>% #–ù–µ–π—Ä–æ–º–µ–¥–∏–∞—Ç–æ—Ä—ã
  full_join(probiotics, by = taxon) %>% #–ü—Ä–æ–±–∏–æ—Ç–∏–∫–∏
  full_join(special_properties, by = taxon) %>% #–° –æ—Å–æ–±—ã–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏
  full_join(vitamins, by = taxon) %>%  #–í–∏—Ç–∞–º–∏–Ω—ã
  full_join(read_xlsx (path, 6), by = taxon) %>% #–ü—Ä–æ–¥—É—Ü–µ–Ω—Ç—ã –ö–¶–î–ö
  full_join(habbits, by = taxon) %>% #–í—Ä–µ–¥–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏
  
  unite("Taxon", TaxonName, Rank, sep = "_") %>% 
  filter (Taxon != "Blautia obeum_S") %>% #–¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–∞–∫—Å–æ–Ω–∞ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –ü—Ä–æ–¥—É—Ü–µ–Ω—Ç—ã –ö–¶–ñ–ö
  mutate_all(as.factor)

rm (path, taxon, neuromediators, probiotics, special_properties, vitamins, habbits)
```

### data_long

-   –ü–µ—Ä–µ–≤–æ–¥ `data_wide` –≤ –¥–ª–∏–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (`data_long`), –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ `data_long` –∏ `bac_functions`

```{r data_long, warning=FALSE}

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∞—Ç–∞—Å–µ—Ç–∞ –≤ –¥–ª–∏–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
data_long <- data_wide %>% 
  pivot_longer(ends_with(c("_D", "_P", "_O", "_C", "_F", "_G")),
               names_to = "Taxon", values_to = "Percentage")

#–ü–µ—Ä–µ–∑–∞–ø–∏—Å—å data_long —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —Ñ—É–Ω–∫—Ü–∏–π –±–∞–∫—Ç–µ—Ä–∏–π
data_long <- data_long %>% 
  left_join (bac_functions, by = "Taxon")

#–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ data_long.rds
write_rds(data_long, 
          file = "data/originals/data_long.rds",
          compress = "gz") 

```

-   –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –¥–ª–∏–Ω–Ω—ã—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∞–∫—Å–æ–Ω–∞

```{r}

G_long <- data_long %>% subset(grepl("_G", Taxon)) 
# %>% select (where (function(x) sum (is.na(x))/ nrow(.) * 100 < threshold_percent))
F_long <- data_long %>% subset(grepl("_F", Taxon))
C_long <- data_long %>% subset(grepl("_C", Taxon))
O_long <- data_long %>% subset(grepl("_O", Taxon))
P_long <- data_long %>% subset(grepl("_P", Taxon))

write_rds(G_long, 
          file = "data/originals/G_long.rds", "gz") 
write_rds(F_long, 
          file = "data/originals/F_long.rds", "gz") 
write_rds(C_long, 
          file = "data/originals/C_long.rds", "gz") 
write_rds(O_long, 
          file = "data/originals/O_long.rds", "gz") 
write_rds(P_long, 
          file = "data/originals/P_long.rds", "gz") 

```

## –§–∞–∫—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑

-   –ü—Ä–æ–≤–µ–¥–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —Ç–∞–∫—Å–æ–Ω–∞ –∏–∑ `combined_bacteria` —Å –ø–æ –≥—Ä—É–ø–ø–µ `Health_state` –∏–∑ `combined_info` –±–µ–∑ —É—á–µ—Ç–∞ —Ç–∞–∫—Å–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è.

```{r}
# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
result_dataset <- data.frame(
  Variable_Name = character(),
  Test_Type = character(),
  P_Value = numeric(),
  Normal_Distribution = character(),
  stringsAsFactors = FALSE
)

alpha = 0.05

# –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞—Ç–∞—Å–µ—Ç—ã –ø–æ patient_id 
combined_data <- data_wide %>%
  select(Health_state,
    ends_with(c("_D", "_P", "_O", "_C", "_F", "_G")))

combined_bacteria_clean <- combined_data

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ –¥–∞—Ç–∞—Å–µ—Ç–∞ combined_bacteria, –∏—Å–∫–ª—é—á–∞—è "patient_ID"
values_to_exclude <- c("patient_ID", "Seq_date", "Age")
variable_names <- setdiff(names(combined_bacteria_clean), values_to_exclude)

# –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞–∂–¥–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
for (variable in variable_names) {
  # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–∏—Å–∫–ª—é—á–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å NA –∏ 0 –≤ —Ç–µ–∫—É—â–µ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π)
  filtered_data <- combined_data[!is.na(combined_data[[variable]]) & combined_data[[variable]] != 0, ]
  #print(variable)
  #print(filtered_data)

  # –ü—Ä–æ–≤–µ—Ä–∏–º —á—Ç–æ –¥–∞—Ç–∞—Å–µ—Ç filtered_data –Ω–µ –ø—É—Å—Ç–æ–π –∏ —á—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–ø–ø —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –±–æ–ª–µ–µ 1, –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ –∏—Ö 2 :)
  if (nrow(filtered_data) > 0 & length(unique(filtered_data$Health_state)) > 1) {
    
  # Check if there is sufficient variability in the data
  if (length(unique(filtered_data$Health_state)) > 1) {
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç—å
    shapiro_test_result <- try(shapiro.test(filtered_data[[variable]]), silent = TRUE)
    if (inherits(shapiro_test_result, "try-error")) {
      warning(paste("Skipping Shapiro-Wilk test for variable", variable, "due to an error."))
      next
    }
    p_value_shapiro <- shapiro_test_result$p.value

    # –í—ã–±–æ—Ä —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∞
    if (p_value_shapiro > 0.05) {
      # –ï—Å–ª–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, –ø—Ä–æ–≤–µ—Å—Ç–∏ –¥–∏—Å–ø–µ—Ä—Å–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑
      model <- aov(filtered_data[[variable]] ~ Health_state, data = filtered_data)
      summary_list <- summary(model)
      test_type <- "ANOVA"
    } else {
      # –ï—Å–ª–∏ –Ω–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç –ö—Ä–∞—Å–∫–µ–ª–∞-–£–æ–ª–ª–∏—Å–∞
      tryCatch({
        model <- kruskal.test(filtered_data[[variable]] ~ Health_state, data = filtered_data)
        test_type <- "Kruskal-Wallis"
      }, error = function(e) {
        warning(paste("Skipping Kruskal-Wallis test for variable", variable, "due to an error:", conditionMessage(e)))
        next
      })
    }

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –≤ –¥–∞—Ç–∞—Å–µ—Ç
    result_dataset <- rbind(result_dataset, 
                            data.frame(Variable_Name = variable,
                                       Test_Type = test_type,
                                       P_Value = ifelse(test_type == "ANOVA", summary_list[[1]]$"Pr(>F)"[1], model$p.value),
                                       Normal_Distribution = ifelse(p_value_shapiro > 0.05, "Yes", "No")))
  } else {
    # If there is no variability, skip the tests
    warning(paste("Skipping tests for variable", variable, "as there is not enough variability in the data."))
  }
  }}

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞ —Å –ø–æ–ø—Ä–∞–≤–∫–æ–π –ë–æ–Ω—Ñ–µ—Ä—Ä–æ–Ω–∏
result_dataset$Adjusted_P_Value_Bonferroni <- p.adjust(result_dataset$P_Value, method = "bonferroni")

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞ —Å –ø–æ–ø—Ä–∞–≤–∫–æ–π –•–æ–ª–º–∞
result_dataset$Adjusted_P_Value_Holm <- p.adjust(result_dataset$P_Value, method = "holm")

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞ —Å –ø–æ–ø—Ä–∞–≤–∫–æ–π –ë–µ–Ω–¥–∂–∞–º–∏–Ω–∏-–•–æ—Ö–±–µ—Ä–≥–∞
result_dataset$Adjusted_P_Value_BH <- p.adjust(result_dataset$P_Value, method = "BH")

result_dataset$test_pass = ifelse(result_dataset$Adjusted_P_Value_Bonferroni < alpha & result_dataset$Adjusted_P_Value_Holm < alpha & result_dataset$Adjusted_P_Value_BH < alpha, "Y", "N")

result_dataset_pass <- result_dataset %>% filter(test_pass == "Y")

# –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
print(result_dataset_pass)

```

-   –ü–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ –¥–∞–Ω–Ω—ã–µ –∑–¥–æ—Ä–æ–≤—ã—Ö –ª—é–¥–µ–π –∏ –ª—é–¥–µ–π —Å –°–†–ö –∫–∞–∫ –Ω–∞ –º–Ω–æ–≥–æ–º–µ—Ä–Ω—ã–π –≤–µ–∫—Ç–æ—Ä –ø–æ –≤—Å–µ–º —Ç–∞–∫—Å–æ–Ω–∞–º –∏ –≥—Ä—É–ø–ø–∞–º

```{r}

combined_bacteria_G <- combined_bacteria_clean %>%
  select(Health_state, ends_with("_G"))

d <- dist(combined_bacteria_G) # euclidean distances between the rows
fit <- cmdscale(d,eig=TRUE, k=2) # k is the number of dim

df_mds <- data.frame(
  x = fit$points[,1],
  y = fit$points[,2]
  )  

df_full <- cbind(df_mds, combined_info) %>% mutate(Health_state_n = case_when(Health_state == "Health"  ~ 0,
                                                                              Health_state == "Disease" ~ 1))

ggplot(df_full, aes(x = x, y = y, color = Health_state)) +
  geom_point() +
  theme_bw() +
  ggtitle("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–∞ —Ç–∞–∫—Å–æ–Ω–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≥—Ä—É–ø–ø—ã –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤")
```

-   –ò—Å–ø–æ–ª—å–∑—É—è –º–µ—Ç–æ–¥ –ø–µ—Ä–º—É—Ç–∞—Ü–∏–π –ø—Ä–æ–≤–µ—Ä–∏–º –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –ª–∏ –≥—Ä—É–ø–ø—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ–º—Ç–∏ –æ—Ç Health_state

```{r permanova}

adonis2(d ~ Health_state_n, data = df_full)

```

## –¢–µ—Å—Ç –ú–∞–Ω–Ω–∞-–£–∏—Ç–Ω–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ —Ç–∞–∫—Å–æ–Ω–∞ –º–µ–∂–¥—É –±–æ–ª—å–Ω—ã–º–∏ –∏ –∑–¥–æ—Ä–æ–≤—ã–º–∏

-   –ø–æ—Å–ª–µ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π **–¥–æ —Ü–µ–ª–æ–≥–æ**

```{r}

Wilcox_comparison_round_0 <- data_wide %>% 
  select(Health_state, Archaea, Bacteria,
         ends_with(c("_D", "_P", "_O", "_C", "_F", "_G"))) %>% 
  mutate(across (where (is.numeric), function (x) round (x,0))) %>% 
  summarise_if (is.numeric, function (x) (wilcox.test(x ~ .$Health_state)$p.value)) %>% 
  pivot_longer(everything()) %>% 
  rename (Taxon = name, p_value = value) %>% 
  filter (p_value <= 0.05 ) %>% 
  arrange(p_value) %>% 
  add_column(p_value_holm = p.adjust(.$p_value, "holm")) %>% 
  add_column(p_value_BH = p.adjust(.$p_value, "BH"))

 rbind (
   "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞—á–∏–º–æ —Ä–∞–∑–ª–∏—á–∞—é—â–∏—Ö—Å—è —Ç–∞–∫—Å–æ–Ω–æ–≤ –ø–æ p_value" = nrow (Wilcox_comparison_round_0),
 "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞—á–∏–º–æ —Ä–∞–∑–ª–∏—á–∞—é—â–∏—Ö—Å—è —Ç–∞–∫—Å–æ–Ω–æ–≤ –ø–æ p_value_holm" = nrow (Wilcox_comparison_round_0 %>% filter (p_value_holm <= 0.05 )),
 "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞—á–∏–º–æ —Ä–∞–∑–ª–∏—á–∞—é—â–∏—Ö—Å—è —Ç–∞–∫—Å–æ–Ω–æ–≤ –ø–æ p_value_BH" = nrow (Wilcox_comparison_round_0 %>% filter (p_value_BH <= 0.05 ))
 )
 
```

-   –ø–æ—Å–ª–µ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π **–¥–æ –¥–µ—Å—è—Ç—ã—Ö**

```{r}

Wilcox_comparison_round_1 <- data_wide %>% 
  select(Health_state, Archaea, Bacteria,
         ends_with(c("_D", "_P", "_O", "_C", "_F", "_G"))) %>% 
  mutate(across (where (is.numeric), function (x) round (x,1))) %>% 
  summarise_if (is.numeric, function (x) (wilcox.test(x ~ .$Health_state)$p.value)) %>% 
  pivot_longer(everything()) %>% 
  rename (Taxon = name, p_value = value) %>% 
  filter (p_value <= 0.05 ) %>% 
  arrange(p_value) %>% 
  add_column(p_value_holm = p.adjust(.$p_value, "holm")) %>% 
  add_column(p_value_BH = p.adjust(.$p_value, "BH"))

 rbind (
   "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞—á–∏–º–æ —Ä–∞–∑–ª–∏—á–∞—é—â–∏—Ö—Å—è —Ç–∞–∫—Å–æ–Ω–æ–≤ –ø–æ p_value" = nrow (Wilcox_comparison_round_1),
 "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞—á–∏–º–æ —Ä–∞–∑–ª–∏—á–∞—é—â–∏—Ö—Å—è —Ç–∞–∫—Å–æ–Ω–æ–≤ –ø–æ p_value_holm" = nrow (Wilcox_comparison_round_1 %>% filter (p_value_holm <= 0.05 )),
 "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞—á–∏–º–æ —Ä–∞–∑–ª–∏—á–∞—é—â–∏—Ö—Å—è —Ç–∞–∫—Å–æ–Ω–æ–≤ –ø–æ p_value_BH" = nrow (Wilcox_comparison_round_1 %>% filter (p_value_BH <= 0.05 ))
 )
 
```

-   –ø–æ—Å–ª–µ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π **–¥–æ —Å–æ—Ç—ã—Ö**

```{r}

Wilcox_comparison_round_2 <- data_wide %>% 
  select(Health_state, Archaea, Bacteria,
         ends_with(c("_D", "_P", "_O", "_C", "_F", "_G"))) %>% 
  mutate(across (where (is.numeric), function (x) round (x,2))) %>% 
  summarise_if (is.numeric, function (x) (wilcox.test(x ~ .$Health_state)$p.value)) %>% 
  pivot_longer(everything()) %>% 
  rename (Taxon = name, p_value = value) %>% 
  filter (p_value <= 0.05 ) %>% 
  arrange(p_value) %>% 
  add_column(p_value_holm = p.adjust(.$p_value, "holm")) %>% 
  add_column(p_value_BH = p.adjust(.$p_value, "BH"))

 rbind (
   "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞—á–∏–º–æ —Ä–∞–∑–ª–∏—á–∞—é—â–∏—Ö—Å—è —Ç–∞–∫—Å–æ–Ω–æ–≤ –ø–æ p_value" = nrow (Wilcox_comparison_round_2),
 "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞—á–∏–º–æ —Ä–∞–∑–ª–∏—á–∞—é—â–∏—Ö—Å—è —Ç–∞–∫—Å–æ–Ω–æ–≤ –ø–æ p_value_holm" = nrow (Wilcox_comparison_round_2 %>% filter (p_value_holm <= 0.05 )),
 "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞—á–∏–º–æ —Ä–∞–∑–ª–∏—á–∞—é—â–∏—Ö—Å—è —Ç–∞–∫—Å–æ–Ω–æ–≤ –ø–æ p_value_BH" = nrow (Wilcox_comparison_round_2 %>% filter (p_value_BH <= 0.05 ))
 )
 
```

## –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∞–∫—Å–æ–Ω–æ–≤ G(Genus - –†–æ–¥)

#### –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ (–ó–¥–æ—Ä–æ–≤ - –°–†–ö)

```{r Genus bar plot by Health_state}

# –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∞–∫—Å–æ–Ω—ã, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏–µ —É—Å–ª–æ–≤–∏—è–º
unique_taxa <- Wilcox_comparison_round_2 %>%
  subset(grepl("_G", Taxon)) %>%
  filter(p_value_holm < 0.05) %>%
  distinct(Taxon)

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä —à–∞–≥–∞ (20 —Ç–∞–∫—Å–æ–Ω–æ–≤ –Ω–∞ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏)
step_size <- 18

# –†–∞–∑–±–∏–≤–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∞–∫—Å–æ–Ω—ã –Ω–∞ –≥—Ä—É–ø–ø—ã –ø–æ step_size
taxon_groups <- split(unique_taxa, rep(1:ceiling(nrow(unique_taxa) / step_size), each = step_size, length.out = nrow(unique_taxa)))

# –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≥—Ä—É–ø–ø–∞–º –∏ —Å—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫–∏
for (i in seq_along(taxon_groups)) {
  current_taxa <- taxon_groups[[i]]
  
  G_long_filtered <- G_long %>%
    filter(Taxon %in% current_taxa$Taxon & Percentage > 0) %>%
    group_by(Health_state, Taxon) %>%
    summarise(Count = n(), .groups = "drop")
  
  bar_plot <- ggplot(G_long_filtered, aes(x = Health_state, y = Count, fill = Health_state == "Disease")) +
    geom_bar(position = "dodge", color = "black", stat = "identity") +
    scale_fill_manual(values = c("skyblue", "red"), guide = FALSE) +
    labs(title = paste("–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –¥–ª—è —Ç–∞–∫—Å–æ–Ω–æ–≤", (i - 1) * step_size + 1, "–¥–æ", min(i * step_size, nrow(unique_taxa)), "–≤ —Ä–∞–∑—Ä–µ–∑–µ Health_state"),
         x = "–°—Ç–∞—Ç—É—Å –ø–∞—Ü–∏–µ–Ω—Ç–∞",
         y = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –æ–±–Ω–∞—Ä—É–∂–µ–Ω –¥–∞–Ω–Ω—ã–π —Ç–∞–∫—Å–æ–Ω") +
    coord_flip() +
    facet_wrap(~Taxon, scales = "free_y", ncol = 2, shrink = 0.7) +  # –£–º–µ–Ω—å—à–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –º–µ–∂–¥—É —Ñ–∞—Å–µ—Ç–∞–º–∏
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 5),  # –ü–æ–≤–æ—Ä–æ—Ç —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –æ—Å–∏ X –∏ —É–º–µ–Ω—å—à–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞
          axis.text.y = element_text(hjust = 1, size = 5),
          strip.text = element_text(size = 5))  # –£–º–µ–Ω—å—à–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–∞—Å–µ—Ç
  
  print(bar_plot)  # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
  
}

```

### –≥—Ä–∞—Ñ–∏–∫ —Å–æ–ª–Ω—ã—à–∫–æ –Ω–µ –≥–æ—Ç–æ–≤ –ø–æ–∫–∞ üò≠

```{r}

# –°–æ–∑–¥–∞–µ–º –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –Ω–∞ –ø–µ—Ä–≤—ã–µ 10 —Ç–∞–∫—Å–æ–Ω–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ Health_state

unique_taxa <- Wilcox_comparison_round_2 %>%
  subset(grepl("_G", Taxon)) %>%
  filter(p_value_holm < 0.05) %>%
  distinct(Taxon)

data <- G_long %>%
  filter(Taxon %in% unique_taxa$Taxon & Percentage > 0) %>%
  group_by(Taxon, Health_state) %>%
  summarise(Count = n(), .groups = "drop") %>%
  arrange(Taxon, Health_state) %>%
  slice_head(n = 20)

# Add a unique id for each Taxon
data <- data %>%
  mutate(id = group_indices(., Taxon))

# Set a number of 'empty bar'
empty_bar <- 10

# Create empty rows with unique id for each Taxon
to_add <- data.frame(
  Taxon = rep(unique(data$Taxon), each = empty_bar),
  Health_state = rep(levels(data$Health_state), times = length(unique(data$Taxon))),
  Count = rep(NA, empty_bar),
  id = rep(seq_len(length(unique(data$Taxon))), each = empty_bar)
)

# Combine the initial dataset with the empty rows
data <- rbind(data, to_add) %>%
  arrange(Taxon, Health_state)

# Reset the id values
data$id <- seq_len(nrow(data))


# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: —Å–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π value –Ω–∞ –æ—Å–Ω–æ–≤–µ Count
data$value <- data$Count
 
# Get the name and the y position of each label
label_data <- data
number_of_bar <- nrow(label_data)/2
angle <- 90 - 360 * (label_data$id-0.5) / (number_of_bar * 2)
label_data$hjust <- ifelse(angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle+180, angle)
 
# Make the plot
p <- ggplot(data, aes(x=as.factor(id), y=value, fill=Health_state)) +       
  geom_bar(stat="identity", position="stack", alpha=0.7) +
  scale_fill_manual(values = c("skyblue", "red")) +  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –¥–≤–∞ —Ü–≤–µ—Ç–∞
  ylim(c(0, max(data$value) + 10)) +
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = unit(rep(-1,4), "cm") 
  ) +
  coord_polar(start = 0) + 
  geom_text(data=label_data, aes(x=id, y=value+5, label=Taxon, hjust=hjust), color="black", fontface="bold", alpha=0.6, size=2.5, angle=label_data$angle, inherit.aes = FALSE ) +
  geom_text(aes(x=as.factor(id), y=value, label=Count), position=position_stack(vjust=0.5), size=2.5, color="black") +  # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π
  labs(title = "–ì—Ä–∞—Ñ–∏–∫ '—Å–æ–ª–Ω—ã—à–∫–æ' –¥–ª—è –ø–µ—Ä–≤—ã—Ö 10 –ø–∞—Ä —Ç–∞–∫—Å–æ–Ω–æ–≤ —Å —Ä–∞–∑–Ω—ã–º–∏ Health_state")

print(p)
```

#### –ë–æ–∫—Å–ø–ª–æ—Ç –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É

```{r box plot for age by Health_state, warning=FALSE}

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä —à–∞–≥–∞ (4 —Ç–∞–∫—Å–æ–Ω–∞ –Ω–∞ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏)
step_size <- 4

# –†–∞–∑–±–∏–≤–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∞–∫—Å–æ–Ω—ã –Ω–∞ –≥—Ä—É–ø–ø—ã –ø–æ step_size
taxon_groups <- split(unique_taxa, rep(1:ceiling(nrow(unique_taxa) / step_size), each = step_size, length.out = nrow(unique_taxa)))

# –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≥—Ä—É–ø–ø–∞–º –∏ —Å—Ç—Ä–æ–∏–º –±–æ–∫—Å–ø–ª–æ—Ç—ã –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π Age
for (i in seq_along(taxon_groups)) {
  current_taxa <- taxon_groups[[i]]
  
  G_long_filtered <- G_long %>%
    filter(Taxon %in% current_taxa$Taxon & Percentage > 0)
  
  # –°—Ç—Ä–æ–∏–º –±–æ–∫—Å–ø–ª–æ—Ç
  box_plot <- ggplot(G_long_filtered, aes(x = Health_state, y = Age, fill = Health_state)) +
    geom_boxplot() +
    labs(title = paste("–ë–æ–∫—Å–ø–ª–æ—Ç—ã –¥–ª—è —Ç–∞–∫—Å–æ–Ω–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É"),
         x = "Health_state",
         y = "Age") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8),  # –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π Taxon
          axis.title.x = element_blank(),  # –£–±–∏—Ä–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Å–∏ X
          legend.position = "bottom") +  # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –ª–µ–≥–µ–Ω–¥—É –≤–Ω–∏–∑
    scale_fill_manual(values = c("red", "skyblue")) +
    facet_grid(~Taxon, scales = "free_y", space = "free")  # –ò—Å–ø–æ–ª—å–∑—É–µ–º facet_grid –≤–º–µ—Å—Ç–æ facet_wrap
  
  # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
  print(box_plot)
  
}

```

### –ë–æ–∫—Å–ø–ª–æ—Ç –ø–æ –≤–æ–∑—Ä–æ—Å—Ç—É –∏ –ø–æ–ª—É

```{r, warning=FALSE}

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä —à–∞–≥–∞ (3 —Ç–∞–∫—Å–æ–Ω–∞ –Ω–∞ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏)
step_size <- 3

# –†–∞–∑–±–∏–≤–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∞–∫—Å–æ–Ω—ã –Ω–∞ –≥—Ä—É–ø–ø—ã –ø–æ step_size
taxon_groups <- split(unique_taxa, rep(1:ceiling(nrow(unique_taxa) / step_size), each = step_size, length.out = nrow(unique_taxa)))

# –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≥—Ä—É–ø–ø–∞–º –∏ —Å—Ç—Ä–æ–∏–º –±–æ–∫—Å–ø–ª–æ—Ç—ã –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π Age
for (i in seq_along(taxon_groups)) {
  current_taxa <- taxon_groups[[i]]
  
  G_long_filtered <- G_long %>%
    filter(Taxon %in% current_taxa$Taxon & Percentage > 0)
  
  # –°—Ç—Ä–æ–∏–º –±–æ–∫—Å–ø–ª–æ—Ç
  box_plot <- ggplot(G_long_filtered, aes(x = interaction(Health_state, Sex), y = Age, fill = Health_state)) +
    geom_boxplot() +
    labs(title = paste("–ë–æ–∫—Å–ø–ª–æ—Ç—ã –¥–ª—è —Ç–∞–∫—Å–æ–Ω–∞ (–ü–æ–ª + —Å—Ç–∞—Ç—É—Å –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è)"),
         x = "Health_state + Sex",
         y = "Age") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8),  # –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π Taxon
          axis.title.x = element_blank(),  # –£–±–∏—Ä–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Å–∏ X
          legend.position = "bottom") +  # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –ª–µ–≥–µ–Ω–¥—É –≤–Ω–∏–∑
    scale_fill_manual(values = c("red", "skyblue")) +
    facet_grid(~Taxon, scales = "free_y", space = "free")  # –ò—Å–ø–æ–ª—å–∑—É–µ–º facet_grid –≤–º–µ—Å—Ç–æ facet_wrap
  
  # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
  print(box_plot)
  
}

```

### –ë–æ–∫—Å–ø–ª–æ—Ç –ø–æ –≤–æ–∑—Ä–æ—Å—Ç—É –∏ —Å—Ç–∞—Ç—É—Å—É –∫—É—Ä–µ–Ω–∏—è

```{r, warning=FALSE}

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä —à–∞–≥–∞ (3 —Ç–∞–∫—Å–æ–Ω–∞ –Ω–∞ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏)
step_size <- 3

# –†–∞–∑–±–∏–≤–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∞–∫—Å–æ–Ω—ã –Ω–∞ –≥—Ä—É–ø–ø—ã –ø–æ step_size
taxon_groups <- split(unique_taxa, rep(1:ceiling(nrow(unique_taxa) / step_size), each = step_size, length.out = nrow(unique_taxa)))

# –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≥—Ä—É–ø–ø–∞–º –∏ —Å—Ç—Ä–æ–∏–º –±–æ–∫—Å–ø–ª–æ—Ç—ã –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π Age
for (i in seq_along(taxon_groups)) {
  current_taxa <- taxon_groups[[i]]
  
  G_long_filtered <- G_long %>%
    filter(Taxon %in% current_taxa$Taxon & Percentage > 0)
  
  # –°—Ç—Ä–æ–∏–º –±–æ–∫—Å–ø–ª–æ—Ç
  box_plot <- ggplot(G_long_filtered, aes(x = interaction(Health_state, Smoking), y = Age, fill = Health_state)) +
    geom_boxplot() +
    labs(title = paste("–ë–æ–∫—Å–ø–ª–æ—Ç—ã –¥–ª—è —Ç–∞–∫—Å–æ–Ω–∞ (–°—Ç–∞—Ç—É—Å –∫—É—Ä–µ–Ω–∏—è + —Å—Ç–∞—Ç—É—Å –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è)"),
         x = "Health_state + Smoking",
         y = "Age") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8),  # –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π Taxon
          axis.title.x = element_blank(),  # –£–±–∏—Ä–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Å–∏ X
          legend.position = "bottom") +  # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –ª–µ–≥–µ–Ω–¥—É –≤–Ω–∏–∑
    scale_fill_manual(values = c("red", "skyblue")) +
    facet_grid(~Taxon, scales = "free_y", space = "free")  # –ò—Å–ø–æ–ª—å–∑—É–µ–º facet_grid –≤–º–µ—Å—Ç–æ facet_wrap
  
  # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
  print(box_plot)
  
}
```

### –ë–æ–∫—Å–ø–ª–æ—Ç –ø–æ –≤–æ–∑—Ä–æ—Å—Ç—É –∏ —Å—Ç–∞—Ç—É—Å—É —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –∞–ª–∫–æ–≥–æ–ª—è

```{r, warning=FALSE}

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä —à–∞–≥–∞ (3 —Ç–∞–∫—Å–æ–Ω–∞ –Ω–∞ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏)
step_size <- 3

# –†–∞–∑–±–∏–≤–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–∞–∫—Å–æ–Ω—ã –Ω–∞ –≥—Ä—É–ø–ø—ã –ø–æ step_size
taxon_groups <- split(unique_taxa, rep(1:ceiling(nrow(unique_taxa) / step_size), each = step_size, length.out = nrow(unique_taxa)))

# –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≥—Ä—É–ø–ø–∞–º –∏ —Å—Ç—Ä–æ–∏–º –±–æ–∫—Å–ø–ª–æ—Ç—ã –¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π Age
for (i in seq_along(taxon_groups)) {
  current_taxa <- taxon_groups[[i]]
  
  G_long_filtered <- G_long %>%
    filter(Taxon %in% current_taxa$Taxon & Percentage > 0)
  
  # –°—Ç—Ä–æ–∏–º –±–æ–∫—Å–ø–ª–æ—Ç
  box_plot <- ggplot(G_long_filtered, aes(x = interaction(Health_state, Alcohol), y = Age, fill = Health_state)) +
    geom_boxplot() +
    labs(title = paste("–ë–æ–∫—Å–ø–ª–æ—Ç—ã –¥–ª—è —Ç–∞–∫—Å–æ–Ω–∞ (–°—Ç–∞—Ç—É—Å —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –∞–ª–∫–æ–≥–æ–ª—è + —Å—Ç–∞—Ç—É—Å –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è)"),
         x = "Health_state + Alcohol",
         y = "Age") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 8),  # –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π Taxon
          axis.title.x = element_blank(),  # –£–±–∏—Ä–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Å–∏ X
          legend.position = "bottom") +  # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –ª–µ–≥–µ–Ω–¥—É –≤–Ω–∏–∑
    scale_fill_manual(values = c("red", "skyblue")) +
    facet_grid(~Taxon, scales = "free_y", space = "free")  # –ò—Å–ø–æ–ª—å–∑—É–µ–º facet_grid –≤–º–µ—Å—Ç–æ facet_wrap
  
  # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
  print(box_plot)
  
}
```
